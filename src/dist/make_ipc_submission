#! /bin/bash

set -o errexit

DIST=seq-opt-bjolp
COMMANDLINEOPTIONS='--search "astar(lmcount(lm_hm(m=1),admissible=true),mpd=true)"'

PACKAGE=$DIST.tar.gz

echo "Making sure destination is clear..."
mkdir $DIST

echo "Exporting code..."
hg archive -I 're:src\/translate\/' $DIST
hg archive -I 're:src\/preprocess\/' $DIST
hg archive -I 're:src\/search\/' $DIST
hg archive -I 're:src\/build_all' $DIST


echo "Preparing distribution directory..."
cp build $DIST/
sed "s/COMMANDLINEOPTIONS/$COMMANDLINEOPTIONS/" plan > $DIST/plan
chmod 755 $DIST/plan

# Packaging
echo "Packaging..."
tar czf $PACKAGE $DIST/
rm -rf $DIST

# Sanity tests
echo "Sanity test: Unpacking package..."
tar xzf $PACKAGE

#testdir=`pwd`/data/tests

#echo "Sanity test: Compiling..."
#cd $DIST
#./build

function planner-test-run () {
    TESTID=$1
    echo "Sanity test: $TESTID..."
    ./plan $testdir/$TESTID-domain.pddl $testdir/$TESTID-problem.pddl $TESTID-plan

    rm -f output.sas output sas_plan
}

#planner-test-run test1
#planner-test-run test2


echo "Cleaning up..."
rm -rf $DIST

echo "Done: $PACKAGE"
